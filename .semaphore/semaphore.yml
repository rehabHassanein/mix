version: v1.0
name: Nedap Healthcare
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Run tests"
    task:
      env_vars:
	- name: NODE_VERSION
          value: 9.7.1
	- name: HOST
	  value: nedap.aperture.test
	- name: CA_CRT_FILE
	  value: /etc/ssl/certs/ca-certificates.crt
      secrets:
        - name: github_hex_token_key
      jobs:
      - name: Run tests
        commands:
          - mix hex.organization auth nedap --key $HEX_NEDAP_KEY
	  - git config --global url."https://$GITHUB_TOKEN:x-oauth-basic@github.com/".insteadOf "https://github.com/";
	  - mix local.rebar --force
	  - mix local.hex --force
	  - mix deps.get
	  - nvm install $NODE_VERSION
	  - nvm use $NODE_VERSION
	  - ./scripts/compile_assets.sh || echo itsnothere
	  - sudo sh -c "echo '127.0.0.1 $HOST' >> /etc/hosts"
	  - chromedriver &
	  - mix test
  - name: "Build release"
      jobs:
      - name: Build release
	commands:
	  - ./scripts/build_on_ci.sh || echo itsnothereeither
#promotions:
#  - name: Send to GH
#    pipeline_file: GH-deploy.yml
#    auto_promote_on:
#      - result: passed
#        branch:
#          - master
